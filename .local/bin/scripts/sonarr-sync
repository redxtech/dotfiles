#!/usr/bin/env sh
    
# logging function
logger () {
    echo "$@" >> "$HOME/.sonarr-sync.log"
}

# main function
main () {
    # set lockfile path
    SS_LOCKFILE="$HOME/.sonarr-sync.lock"

    # exit if the lockfile exists
    if test -f "$SS_LOCKFILE"; then
        echo "sonarr-sync is already running"
        return 1
    fi

    # create the lockfile
    touch "$SS_LOCKFILE"

    # set some variables for remote and locations
    SS_REMOTE="sonarr"

    SS_DEST="$HOME/wd/Media/sonarr"
    SS_SOURCE="$SS_REMOTE:/sonarr-lw829/"
    SS_CONFIG="$HOME/.config/rclone/rclone.conf"
    SS_BW="--bwlimit 5M"

    # if a param is specified use the second remote
    if test -n "$2"; then
        SS_REMOTE="sonarr3"
    fi

    # alternate cases for different setups
    case $1 in
        sb|seedbox) # seedbox
            SS_DEST="$SS_REMOTE:/sonarr-lw829/"
            SS_SOURCE="$HOME/media/tv"
            SS_BW=""
            ;;
        lap|laptop) # laptop setup
            SS_DEST="$HOME/media/sonarr/"
            SS_BW=""
            ;;
    esac

    # log that it has started
    logger "Syncing ($(date "+%Y/%m/%d %H:%M"))..."

    # sync the folders
    rclone sync -P "$SS_SOURCE" "$SS_DEST" --config="$SS_CONFIG" --transfers=20 $SS_BW

    # log that it is finished
    logger "Syncing completed."

    # remove the lockfile
    rm -rf "$SS_LOCKFILE"
}

main "$@"


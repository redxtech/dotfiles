#!/usr/bin/env sh

main () {
    KEYMAP="redxtech"
    QMK_HOME="$HOME/qmk_firmware"

    echo "Moving $KEYMAP.json from downloads..."
    mv "$HOME/Downloads/$KEYMAP.json" "$QMK_HOME/qmmk_pro_ansi_layout_$KEYMAP.json" || echo return 1

    echo "Compiling $KEYMAP.json to keymap.c..."
    qmk json2c -o "$QMK_HOME/keyboards/gmmk/pro/ansi/keymaps/$KEYMAP/keymap.c" \
        "$QMK_HOME/gmmk_pro_ansi_layout_$KEYMAP.json" | return 1

    echo "Taking overship of keymap.c..."
    sudo chown gabe "$QMK_HOME/keyboards/gmmk/pro/ansi/keymaps/$KEYMAP/keymap.c"

    echo "Appending rotary encoder to $KEYMAP/keymap.c..."
    (
    cat << EOF
bool encoder_update_user(uint8_t index, bool clockwise) {
    if (clockwise) {
        tap_code(KC_VOLU);
    } else {
        tap_code(KC_VOLD);
    }

    return true;
}

EOF
    ) | sudo tee -a "$QMK_HOME/keyboards/gmmk/pro/ansi/keymaps/$KEYMAP/keymap.c" >/dev/null

    echo "Keymap ready to flash!"

    if test "$1" = "flash"; then
        echo "Compiling firmware..."
        qmk compile

        echo "Starting countdown before flash..."
        # echo "Flashing in 10 seconds..."
        # sleep 5
        echo "Flashing in 5 seconds..."
        sleep 1
        echo "Flashing in 4 seconds..."
        sleep 1
        echo "Flashing in 3 seconds..."
        sleep 1
        echo "Flashing in 2 seconds..."
        sleep 1
        echo "Flashing in 1 second..."
        sleep 1

        echo "Flashing board..."
        qmk flash -km "$KEYMAP"

        echo "Flashing complete!"
    fi
}

main "$1"


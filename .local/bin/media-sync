#!/usr/bin/env sh

main () {
  # config options
  bwlimit="50M"
  transfers="20"

  # command line args
  session="$1"
  src="$2"
  dest="$3"
  cron="$4"

  # make sure command line args were passed
  if test -z "$session"; then
    echo "you need to specify a name for the session"
    return 1
  fi

  if test -z "$src"; then
    echo "you need to specify a source"
    return 1
  fi

  if test -z "$dest"; then
    echo "you need to specify a destination"
    return 1
  fi

  # populate variables
  session="ms-$session"
  if test -n "$bwlimit"; then
    bwlimit="--bwlimit=$bwlimit"
  fi
  if test -n "$transfers"; then
    transfers="--transfers=$transfers"
  fi

  # build the rclone command
  rclone_command="rclone sync -P $transfers $bwlimit \"$src\" \"$dest\""

  # if session exists, attach to it, otherwise, spawn a new session with the rclone command
  if tmux has-session -t "$session" 2>/dev/null; then
    echo "session already exists, attaching..."
    tmux attach -t "$session"
  else
    # make sure tmux is able to run
    if test -n "$TMUX"; then
      TMUX=""
    fi

    # create a new tmux session and run the rclone command
    tmux new-session -d -s "$session" "$rclone_command"

    # connect to tmux session if not from cron
    if test -z "$cron"; then
      tmux attach -t "$session"
    fi
  fi

}

main "$@"

